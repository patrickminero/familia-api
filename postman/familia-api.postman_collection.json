{
  "info": {
    "name": "Familia API - Auth",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "version": "1.0.0",
    "description": "Requests for registrations and sessions (login/logout)\nRequires an environment with `baseUrl` set (e.g. http://localhost:3000)"
  },
  "item": [
    {
      "name": "Auth",
      "item": [
        {
          "name": "Register - POST /api/v1/users",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" },
              { "key": "Accept", "value": "application/json" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"user\": {\n    \"email\": \"test+{{random}}@example.com\",\n    \"password\": \"password123\",\n    \"password_confirmation\": \"password123\",\n    \"profile_attributes\": { \"name\": \"Test User\", \"timezone\": \"UTC\" }\n  }\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/v1/users",
              "host": ["{{baseUrl}}"],
              "path": ["api", "v1", "users"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Expect created (201)",
                  "pm.test('status is 201', function() { pm.response.to.have.status(201); });",
                  "// Try to extract token from header or response body",
                  "var authHeader = pm.response.headers.get('Authorization');",
                  "if (authHeader) {",
                  "  var token = authHeader.replace(/Bearer /i, '').trim();",
                  "  pm.environment.set('authToken', token);",
                  "  pm.test('Authorization header present', function() { pm.expect(authHeader).to.match(/^Bearer\\s+/i); });",
                  "} else {",
                  "  var json = pm.response.json();",
                  "  if (json && json.data && json.data.token) {",
                  "    pm.environment.set('authToken', json.data.token);",
                  "    pm.test('token present in body', function() { pm.expect(json.data.token).to.be.a('string'); });",
                  "  }",
                  "}",
                  "// set a random value for reuse if needed",
                  "pm.environment.set('random', Math.floor(Math.random()*10000));"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Login - POST /api/v1/users/login",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" },
              { "key": "Accept", "value": "application/json" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"user\": {\n    \"email\": \"test+{{random}}@example.com\",\n    \"password\": \"password123\"\n  }\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/v1/users/login",
              "host": ["{{baseUrl}}"],
              "path": ["api", "v1", "users", "login"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('status is 200', function() { pm.response.to.have.status(200); });",
                  "var authHeader = pm.response.headers.get('Authorization');",
                  "if (authHeader) {",
                  "  var token = authHeader.replace(/Bearer /i, '').trim();",
                  "  pm.environment.set('authToken', token);",
                  "  pm.test('Authorization header present', function() { pm.expect(authHeader).to.match(/^Bearer\\s+/i); });",
                  "} else {",
                  "  var json = pm.response.json();",
                  "  pm.test('response has data.token', function() { pm.expect(json.data.token).to.be.a('string'); });",
                  "  pm.environment.set('authToken', json.data.token);",
                  "}",
                  "// basic checks for user/profile fields",
                  "var json = pm.response.json();",
                  "if (json && json.data && json.data.user) {",
                  "  pm.test('user.email present', function() { pm.expect(json.data.user.email).to.be.a('string'); });",
                  "}",
                  "if (json && json.data && json.data.expires_at) {",
                  "  pm.test('expires_at present', function() { pm.expect(json.data.expires_at).to.be.a('string'); });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Logout - DELETE /api/v1/users/logout",
          "request": {
            "method": "DELETE",
            "header": [
              { "key": "Accept", "value": "application/json" },
              { "key": "Authorization", "value": "Bearer {{authToken}}" }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/v1/users/logout",
              "host": ["{{baseUrl}}"],
              "path": ["api", "v1", "users", "logout"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('status is 200 or 204', function() { pm.expect(pm.response.code).to.be.oneOf([200,204]); });",
                  "pm.test('logout returns success message', function() { var json = pm.response.json(); if (json) { pm.expect(json.message || '').to.be.a('string'); } });",
                  "// clear token from environment",
                  "pm.environment.unset('authToken');"
                ],
                "type": "text/javascript"
              }
            }
          ]
        }
      ]
    }
  ]
}
